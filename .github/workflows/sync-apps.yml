name: Sync app registry

on:
  push:
    branches: [main]
    paths:
      - 'apps/**'
      - '!apps/index.json'   # bot's own commit must not re-trigger this

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Rebuild apps/index.json
        run: |
          node -e "
            const fs = require('fs');
            const apps = fs.readdirSync('apps')
              .filter(d => {
                try {
                  return fs.statSync('apps/' + d).isDirectory()
                      && fs.existsSync('apps/' + d + '/index.html');
                } catch { return false; }
              })
              .sort();
            fs.writeFileSync('apps/index.json', JSON.stringify(apps) + '\n');
            console.log('registry:', apps);
          "

      - name: Commit if changed
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add apps/index.json
          if ! git diff --staged --quiet; then
            git commit -m "chore: sync apps/index.json"
            git push
          else
            echo "apps/index.json already up to date"
          fi
